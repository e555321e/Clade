# 生态拟真系统优化设计方案

> 版本：v1.0  
> 日期：2024-12  
> 状态：设计阶段

---

## 1. 背景与目标

### 1.1 现状分析

当前系统已实现的生态机制：
- **NPP 系统**：基于 Miami 模型的气候-生产力耦合
- **死亡率系统**：多压力源叠加（环境、竞争、捕食、资源）
- **繁殖系统**：逻辑斯谛增长模型
- **食物网**：捕食关系与能量传递
- **迁徙系统**：基于宜居度的栖息地选择

### 1.2 待优化方向

现有系统在以下方面存在简化：
1. **小种群动态**：缺少 Allee 效应（种群过小时的非线性衰退）
2. **密度依赖效应**：高密度种群的疾病/寄生虫风险未建模
3. **环境随机性**：地质时间尺度的气候脉动不足
4. **空间生态**：捕食效率未充分考虑空间重叠
5. **能量流动**：同化效率使用固定值而非物种特征驱动
6. **生态位分化**：垂直分层和微栖息地差异化不足
7. **演化滞后**：环境变化速率与适应能力的匹配问题
8. **种间互作**：缺少互利共生的正向反馈机制

### 1.3 设计原则

**核心原则：语义驱动，拒绝硬编码**

所有生态学判断必须通过 **embedding 语义匹配** 实现，而非关键词枚举。

| ❌ 避免 | ✅ 采用 |
|--------|--------|
| `if diet_type == "carnivore"` | 计算与"肉食性捕食者"的语义相似度 |
| `if habitat == "forest"` | 计算与各栖息地描述的语义相似度分布 |
| 硬编码的类型映射表 | 预定义语义锚点 + 动态相似度计算 |

---

## 2. 优化模块设计

### 2.1 Allee 效应模块

**功能**：模拟小种群困境——当种群规模低于阈值时，繁殖效率和存活率非线性下降。

**生态学原理**：
- 配偶难觅：种群稀疏时个体难以找到交配对象
- 集体防御崩溃：群居物种失去群体保护优势
- 遗传多样性丧失：近交衰退加剧

**修改方向**：
- 在 `ReproductionService` 中引入 Allee 效应修正因子
- 基于 `population / carrying_capacity` 比值计算
- 当种群低于动态计算的 MVP（最小可存活种群）时触发

**期望效果**：
- 濒危物种更难恢复，需要主动干预
- 种群崩溃呈现"临界点"特征而非线性衰退
- 增加灭绝的不可逆性，提升游戏紧张感

---

### 2.2 密度依赖疾病模块

**功能**：高密度种群自动面临更高的疾病/寄生虫压力。

**生态学原理**：
- 密度效应：拥挤环境加速病原体传播
- 社会性放大：群居物种传播风险更高
- 免疫权衡：繁殖投入高的物种免疫力相对较弱

**修改方向**：
- 在死亡率计算中新增疾病压力分量
- 通过 embedding 匹配判断物种的"群居性"和"抗病性"
- 疾病压力 = f(密度比, 群居性相似度, 抗病性相似度)

**语义锚点示例**：
- 群居性锚点："群居生活、社会性动物、集群行为、兽群、蜂群"
- 抗病性锚点："免疫力强、抗病性、耐受病原体、健壮体质"

**期望效果**：
- 种群爆发后自然受到疾病抑制
- 形成更真实的种群波动周期
- 群居策略有收益也有风险权衡

---

### 2.3 环境综合变数模块

**功能**：模拟地质时间尺度的长周期环境波动（非季节性）。

**生态学原理**：
- 米兰科维奇周期：约10万年的冰期-间冰期循环
- 火山活动周期：超级火山的长期影响与恢复
- 海洋环流变迁：营养盐分布的长期变化

**修改方向**：
- 在 `ResourceManager` 或回合执行流程中引入长周期波动
- 波动幅度与纬度相关（高纬度受影响更大）
- 通过 embedding 匹配判断物种的"环境适应性"
- 广适性物种受波动影响小，专化物种受影响大

**语义锚点示例**：
- 广适性锚点："广适性、环境耐受、机会主义、适应力强、杂食"
- 专化性锚点："专化、狭适性、特化环境、敏感、对特定条件依赖"

**期望效果**：
- 环境不再是静态背景，而是动态变化
- 专化物种在稳定期繁荣，在波动期衰退
- 广适性物种稳定但难以在竞争中占优

---

### 2.4 空间显式捕食效率模块

**功能**：捕食效率受捕食者与猎物的地理重叠程度影响。

**生态学原理**：
- 空间隔离是重要的避难所机制
- 捕食者必须"找到"猎物才能捕食
- 迁徙和扩散改变捕食压力分布

**修改方向**：
- 在 `PredationService` 的捕食压力计算中加入空间重叠因子
- 重叠度 = 共同栖息地块数 / 猎物总栖息地块数
- 通过 embedding 匹配判断捕食策略（伏击/追逐/群猎）与防御策略（速度/护甲/伪装）的对抗

**语义锚点示例**：
- 捕食策略："伏击埋伏"、"追逐捕猎"、"群体协作围猎"
- 防御策略："快速逃跑"、"硬壳装甲"、"保护色伪装"、"群体警戒"

**期望效果**：
- 猎物通过迁徙到捕食者稀少区域获得避难
- 捕食者需要"追踪"猎物分布
- 形成更真实的捕食者-猎物空间博弈

---

### 2.5 能量同化效率模块

**功能**：基于物种特征动态计算能量转化效率，而非使用固定值。

**生态学原理**：
- 肉食性动物同化效率高（~30%），草食性较低（~15%）
- 变温动物效率高于恒温动物（无需产热）
- 滤食性、腐食性等特殊策略有独特效率

**修改方向**：
- 在 `ResourceManager` 或承载力计算中使用动态效率
- 通过 embedding 计算物种与各饮食类型锚点的相似度
- 加权平均得到该物种的同化效率
- 代谢类型（恒温/变温）作为修正因子

**语义锚点示例**：
- 草食锚点："草食、植食、以植物为食、纤维素消化"
- 肉食锚点："肉食、捕食者、以动物为食、高蛋白"
- 恒温锚点："恒温、温血、高代谢、维持体温"
- 变温锚点："变温、冷血、低代谢、体温随环境"

**期望效果**：
- 高营养级物种的承载力更精确
- 不同生态策略有差异化的能量效率
- 无需维护类型枚举表，自动适应新物种

---

### 2.6 垂直生态位分层模块

**功能**：识别物种的垂直生态位，降低同层竞争，允许不同层物种共存。

**生态学原理**：
- 森林分层：林冠层、林下层、灌木层、地被层
- 水体分层：表层、中层、底栖
- 空间分离减少竞争排斥

**修改方向**：
- 在竞争压力计算中引入垂直生态位重叠度
- 通过 embedding 计算物种与各垂直层锚点的相似度分布
- 同层物种竞争强，异层物种竞争弱

**语义锚点示例**：
- "树冠层活动、林冠、高处栖息"
- "林下层、灌木丛、中层活动"
- "地面活动、地栖、穴居、土壤"
- "水面漂浮、表层水域"
- "水底、底栖、海床"

**期望效果**：
- 同一地块可容纳更多物种（垂直分化）
- 减少"一物种独大"的竞争排斥
- 形成更丰富的群落结构

---

### 2.7 适应滞后模块

**功能**：当环境变化速率超过物种适应能力时，产生额外压力。

**生态学原理**：
- 演化需要时间，快速变化导致适应不良
- 可塑性高的物种能更快响应
- 世代时间短的物种演化更快

**修改方向**：
- 追踪环境变化速率（温度、湿度、资源等的变化幅度）
- 通过 embedding 判断物种的"表型可塑性"
- 结合世代时间计算适应能力
- 当变化速率 > 适应能力时，施加死亡率惩罚

**语义锚点示例**：
- 高可塑性："适应力强、表型可变、行为灵活、学习能力强"
- 低可塑性："特化、固定形态、行为刻板、专一性强"

**期望效果**：
- 突变环境（如火山爆发）对专化物种打击更大
- 广适性物种在剧变中存活率更高
- 为"渐变演化"vs"剧变灭绝"提供机制基础

---

### 2.8 互利共生网络模块

**功能**：自动识别和维护物种间的互利共生关系。

**生态学原理**：
- 传粉者-开花植物：相互依赖的繁殖关系
- 种子散布者-果实植物：扩散与食物交换
- 菌根共生：营养物质交换

**修改方向**：
- 通过 embedding 匹配自动发现潜在共生对
- 建立共生关系强度评分
- 共生伙伴存在时双方获得加成
- 伙伴灭绝时依赖方受到惩罚

**语义锚点示例**：
- 传粉者："传粉、访花、采蜜、花粉传播"
- 开花植物："开花、花蜜、花粉、被子植物"
- 种子散布："种子传播、果实、散布种子"
- 果实植物："果实、浆果、坚果"

**期望效果**：
- 形成相互依赖的物种网络
- 关键物种灭绝引发级联效应
- 丰富生态系统的复杂性和脆弱性

---

## 3. 实施优先级

| 优先级 | 模块 | 复杂度 | 生态影响 | 依赖 |
|--------|------|--------|----------|------|
| P0 | Allee 效应 | 低 | 高 | 无 |
| P0 | 密度依赖疾病 | 中 | 高 | Embedding服务 |
| P1 | 环境综合变数 | 中 | 高 | Embedding服务 |
| P1 | 空间显式捕食 | 中 | 中 | 栖息地数据 |
| P2 | 能量同化效率 | 低 | 中 | Embedding服务 |
| P2 | 垂直生态位 | 中 | 中 | Embedding服务 |
| P3 | 适应滞后 | 低 | 中 | 环境变化追踪 |
| P3 | 互利共生 | 高 | 中 | Embedding服务 |

---

## 4. 技术要求

### 4.1 Embedding 服务扩展

需要扩展现有 `EmbeddingIntegrationService`：
- 支持预定义语义锚点的批量编码和缓存
- 提供高效的 batch 相似度计算接口
- 锚点 embedding 在服务启动时预计算

### 4.2 配置化

所有新模块的参数应纳入 `UIConfig` 配置体系：
- Allee 效应阈值
- 疾病压力系数
- 环境波动幅度
- 共生关系强度衰减

### 4.3 性能考量

- 语义锚点 embedding 必须缓存，避免重复计算
- 批量物种处理使用向量化操作
- 共生关系网络每回合增量更新

---

## 5. 预期成果

### 5.1 游戏体验

- **更真实的种群动态**：波动、崩溃、恢复的周期性模式
- **更丰富的生态互动**：竞争、捕食、共生的复杂网络
- **更有意义的玩家决策**：干预时机和对象的选择更重要
- **更强的涌现叙事**：级联灭绝、共生网络崩溃等戏剧性事件

### 5.2 系统鲁棒性

- **无硬编码依赖**：新物种自动获得正确的生态学属性
- **语义驱动**：AI 生成的任何描述都能被正确解析
- **可配置**：所有参数可通过设置界面调整

---

## 6. 附录：语义锚点汇总

以下锚点用于 embedding 相似度计算，实际文本可根据效果调优：

```
# 社会性与疾病
social_behavior: "群居生活、社会性动物、集群行为、群体活动"
disease_resistant: "免疫力强、抗病性、耐受病原体、健壮"

# 环境适应性
generalist: "广适性、环境耐受、机会主义、适应力强"
specialist: "专化、狭适性、特化环境、敏感"

# 捕食与防御
ambush_hunter: "伏击、埋伏、隐蔽等待、突袭"
pursuit_hunter: "追逐、耐力捕猎、持久奔跑"
speed_defense: "快速逃跑、敏捷、高速奔跑"
armor_defense: "硬壳、装甲、厚皮、防护"

# 饮食类型
herbivore: "草食、植食、以植物为食、纤维素"
carnivore: "肉食、捕食者、以动物为食、蛋白质"
omnivore: "杂食、什么都吃、机会主义取食"

# 代谢类型
endotherm: "恒温、温血、高代谢、维持体温"
ectotherm: "变温、冷血、低代谢、体温随环境"

# 垂直生态位
canopy: "树冠层、林冠、高处活动、树顶"
understory: "林下层、灌木层、中层"
ground: "地面、地栖、穴居、土壤"
aquatic_surface: "水面、漂浮、表层水域"
aquatic_benthic: "水底、底栖、海床"

# 可塑性
high_plasticity: "适应力强、表型可变、行为灵活"
low_plasticity: "特化、固定形态、行为刻板"

# 共生角色
pollinator: "传粉、访花、采蜜、花粉传播"
flowering_plant: "开花、花蜜、花粉、被子植物"
seed_disperser: "种子传播、果实、散布种子"
```

---

*本文档将随开发进度更新。*


