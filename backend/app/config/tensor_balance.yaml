# 张量系统数值平衡配置
# 
# 此文件定义了张量计算系统的所有可调节参数。
# 可通过修改这些值来调整生态平衡和演化动态。
# 
# 使用方式：
#   from app.tensor import TensorConfig
#   config = TensorConfig.from_dict(yaml.safe_load(open("tensor_balance.yaml")))

# ============================================================================
# 功能开关
# ============================================================================
use_tensor_mortality: true      # 启用张量死亡率计算
use_tensor_speciation: true     # 启用张量分化检测
use_auto_tradeoff: true         # 启用自动代价计算

# ============================================================================
# 数值平衡配置 (balance)
# ============================================================================
balance:
  # === 死亡率计算 ===
  temp_optimal: 20.0            # 最适温度（°C），物种在此温度下死亡率最低
  temp_tolerance: 15.0          # 温度容忍范围（°C），越大对温度变化越不敏感
  temp_channel_idx: 1           # 环境张量中温度通道的索引
  temp_optimal_shift_per_100_turns: 0.0   # 每100回合最适温度漂移（°C）
  temp_tolerance_shift_per_100_turns: 0.0 # 每100回合容忍度变化（°C）
  
  # === 种群动态 ===
  diffusion_rate: 0.1               # 种群扩散率（0-1）
  diffusion_rate_growth_per_100_turns: 0.0  # 扩散率每100回合增加值
  birth_rate: 0.1                   # 基础出生率（0-1）
  birth_rate_growth_per_100_turns: 0.0      # 出生率每100回合增加值
  competition_strength: 0.01        # 种间竞争强度
  competition_decay_per_100_turns: 0.0      # 每100回合竞争强度衰减
  capacity_multiplier: 10000.0      # 承载力乘数，基于植被计算
  veg_capacity_sensitivity: 0.0     # 承载力对平均植被的敏感度 (avg_veg-0.5)
  
  # === 分化检测 ===
  divergence_threshold: 0.5     # 环境分歧检测阈值（0-1）
                                # 超过此值触发生态分化信号
  divergence_normalizer: 10.0   # 环境方差归一化除数
                                # 用于将方差映射到 0-1 范围
  
  # === 适应度计算 ===
  fitness_min: 0.1              # 最低适应度（避免除零）

# ============================================================================
# 演化代价配置 (tradeoff)
# ============================================================================
tradeoff:
  # === 代价计算参数 ===
  tradeoff_ratio: 0.7           # 代价/增益比例（0.5-1.0）
                                # 0.7 = 增加2点属性需要减少1.4点其他属性
                                # 1.0 = 完全能量守恒
  max_single_penalty: 2.0       # 单属性最大扣减量
  penalty_parent_ratio: 0.3     # 从父系值扣减的最大比例
                                # 0.3 = 最多扣减父系该属性的30%
  min_penalty_threshold: 0.1    # 代价量低于此值时忽略
  
  # === 能量成本权重 ===
  # 高成本属性增益需要更多代价，低成本属性代价较小
  energy_costs:
    运动能力: 1.5               # 高成本 - 需要肌肉/骨骼/代谢支持
    智力: 2.0                   # 最高成本 - 大脑能耗极高
    繁殖速度: 1.0               # 中等成本
    耐寒性: 0.6                 # 低成本 - 被动适应
    耐热性: 0.6                 # 低成本 - 被动适应
    物理防御: 0.7               # 较低成本 - 结构性特征
    感知能力: 1.2               # 中高成本 - 神经系统维护
    社会性: 0.8                 # 较低成本 - 行为特征
    体型: 1.0                   # 中等成本 - 资源需求增加
  
  # === 属性竞争关系 ===
  # 增强某属性时，优先从这些竞争属性中扣减
  # 基于生物学原理：能量分配、结构权衡等
  competition_map:
    运动能力:                   # 提高运动能力时...
      - 物理防御                # 装甲增重降低灵活性
      - 体型                    # 大体型不利于快速移动
      - 繁殖速度                # 能量分配权衡
    物理防御:
      - 运动能力                # 装甲增重
      - 繁殖速度
    耐寒性:
      - 耐热性                  # 热适应互斥
      - 繁殖速度
    耐热性:
      - 耐寒性
      - 繁殖速度
    智力:
      - 繁殖速度                # r/K 策略权衡
      - 体型                    # 大脑/身体比例
    感知能力:
      - 繁殖速度                # 神经系统维护成本
    体型:
      - 运动能力
      - 繁殖速度
  
  # === 默认代价候选池 ===
  # 当没有明确竞争关系时，从这些属性中选择扣减
  default_penalty_pool:
    - 繁殖速度                  # 最常见的权衡目标
    - 运动能力
    - 社会性

# ============================================================================
# 压力桥接配置 (pressure_bridge)
# ============================================================================
# 
# 控制压力修改器→张量死亡率的转换参数。
# 【平衡调整v1】大幅降低所有系数，避免压力爆炸
# 
# 设计目标：
#   - 单压力强度10 → 约 25-35% 死亡率（无抗性物种）
#   - 三压力都是10 → 约 60-75% 死亡率（极端但有幸存者）
# 
pressure_bridge:
  # === 温度压力 ===
  thermal_multiplier: 3.0         # 每单位温度压力=3°C温度变化（降低）
  
  # === 毒性压力 ===
  toxin_base_mortality: 0.06      # 每单位毒性=6%基础死亡率（从20%降低）
  autotroph_toxin_benefit: 0.15   # 化能自养受益系数（降低）
  
  # === 干旱压力 ===
  drought_base_mortality: 0.05    # 每单位干旱=5%基础死亡率（从15%降低）
  
  # === 缺氧压力 ===
  anoxic_base_mortality: 0.08     # 每单位缺氧=8%基础死亡率（从25%降低）
  aerobe_sensitivity: 0.6         # 需氧生物敏感度（降低）
  
  # === 直接死亡 ===
  direct_mortality_rate: 0.04     # 每单位直接死亡=4%死亡率（从10%降低）
  
  # === 辐射压力 ===
  radiation_base_mortality: 0.04  # 每单位辐射=4%基础死亡率（从12%降低）
  
  # === 多压力衰减 ===
  multi_pressure_decay: 0.7       # 多压力边际递减系数
                                  # 第1个压力通道×1，第2个×0.7，第3个×0.49...

# ============================================================================
# 使用示例
# ============================================================================
# 
# Python 代码：
# ```python
# import yaml
# from app.tensor import TensorConfig
# 
# # 从 YAML 加载
# with open("tensor_balance.yaml") as f:
#     config = TensorConfig.from_dict(yaml.safe_load(f))
# 
# # 查看配置
# print(config.balance.temp_optimal)  # 20.0
# print(config.tradeoff.tradeoff_ratio)  # 0.7
# 
# # 创建 TradeoffCalculator
# from app.tensor import TradeoffCalculator
# calculator = TradeoffCalculator(config=config.tradeoff)
# 
# # 使用压力桥接
# from app.tensor import PressureBridgeConfig, MultiFactorMortality
# bridge_config = PressureBridgeConfig(
#     thermal_multiplier=config_data.get("pressure_bridge", {}).get("thermal_multiplier", 5.0),
#     # ... 其他配置
# )
# mortality_calc = MultiFactorMortality(config=bridge_config)
# ```

